<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Data input</title>
  <meta name="description" content="Paste Excel-like data and save to Supabase." />
  <style>
    :root{
      --bg:#f7f8fb;
      --ink:#0b0f1a;
      --ink-soft:#475569;
      --muted:#64748b;
      --surface:#ffffff;
      --border:rgba(2,6,23,.10);
      --shadow: 0 18px 70px rgba(2,6,23,.10);
      --shadow-soft: 0 10px 35px rgba(2,6,23,.08);
      --radius:24px;
      --radius2:18px;
      --brand:#0b0f1a;
      --brand-2:#111827;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --ring: 0 0 0 6px rgba(99,102,241,.18);
      --grad: radial-gradient(1000px 500px at 15% 30%, rgba(236,72,153,.16), transparent 70%),
              radial-gradient(900px 480px at 75% 40%, rgba(168,85,247,.18), transparent 65%),
              radial-gradient(1000px 650px at 55% 85%, rgba(34,211,238,.16), transparent 70%);
      --navH: 72px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0;
      font-family: var(--sans);
      color:var(--ink);
      background: linear-gradient(#f7f8fb, #f7f8fb) fixed;
    }
    .bg{
      position: fixed;
      inset: 0;
      background: var(--grad);
      pointer-events: none;
    }
    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      height: var(--navH);
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 0 28px;
      background: rgba(247,248,251,.72);
      backdrop-filter: blur(14px);
      border-bottom: 1px solid var(--border);
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      font-weight: 800;
      letter-spacing: -0.02em;
    }
    .logo{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      background: #0b0f1a;
      display:grid;
      place-items:center;
      color:#fff;
      font-weight: 900;
      font-size: 14px;
      line-height: 1;
      box-shadow: 0 10px 25px rgba(2,6,23,.18);
    }
    .chips{ display:flex; gap:10px; align-items:center; flex-wrap: wrap; justify-content:flex-end }
    .chip{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.7);
      backdrop-filter: blur(10px);
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 13px;
      color: var(--muted);
      display:flex;
      gap: 8px;
      align-items:center;
      box-shadow: 0 8px 25px rgba(2,6,23,.06);
      max-width: min(540px, 70vw);
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .chip strong{ color: var(--ink); font-weight: 700 }
    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 28px 22px 70px;
    }
    .heroGrid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 22px;
      align-items: stretch;
      margin-top: 18px;
    }
    @media (max-width: 980px){
      .heroGrid{ grid-template-columns: 1fr; }
      .topbar{ padding: 0 16px; }
      .wrap{ padding: 18px 14px 60px; }
    }
    .card{
      background: rgba(255,255,255,.82);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .cardInner{ padding: 26px; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 13px;
      color: var(--muted);
      background: rgba(255,255,255,.8);
    }
    .big{
      font-size: 64px;
      line-height: .92;
      letter-spacing: -0.05em;
      margin: 16px 0 14px;
      font-weight: 900;
    }
    @media (max-width: 980px){
      .big{ font-size: 54px; }
    }
    .lead{
      font-size: 16px;
      color: var(--ink-soft);
      line-height: 1.6;
      max-width: 56ch;
    }
    .note{
      margin-top: 18px;
      padding: 14px 14px;
      border: 1px solid var(--border);
      border-radius: 16px;
      color: var(--muted);
      font-size: 13.5px;
      line-height: 1.45;
      background: rgba(255,255,255,.86);
    }
    .note strong{ color: var(--ink) }
    .authTitle{
      font-size: 22px;
      font-weight: 800;
      margin: 0 0 14px;
      letter-spacing: -0.02em;
    }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 980px){
      .grid2{ grid-template-columns: 1fr; }
    }
    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
      letter-spacing: .02em;
      margin: 8px 0 6px;
    }
    input[type="email"], input[type="password"], input[type="text"]{
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 14px;
      background: rgba(255,255,255,.95);
      outline: none;
    }
    input:focus{
      box-shadow: var(--ring);
      border-color: rgba(99,102,241,.35);
    }
    .btnRow{ display:flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    .btn{
      appearance: none;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      background: rgba(255,255,255,.92);
      box-shadow: 0 10px 22px rgba(2,6,23,.06);
    }
    .btn.primary{
      background: #0b0f1a;
      border-color: #0b0f1a;
      color: #fff;
      box-shadow: 0 16px 28px rgba(2,6,23,.20);
    }
    .btn:disabled{ opacity: .55; cursor: not-allowed; }
    .hint{
      margin-top: 10px;
      color: var(--muted);
      font-size: 13px;
    }
    .alert{
      margin-top: 14px;
      border-radius: 14px;
      padding: 12px 12px;
      border: 1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.07);
      color: #991b1b;
      font-weight: 700;
      font-size: 13.5px;
      display:none;
    }
    .alert.ok{
      border-color: rgba(22,163,74,.35);
      background: rgba(22,163,74,.08);
      color: #14532d;
    }
    .appShell{ display:none; margin-top: 22px; }
    .appHeader{
      display:flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: space-between;
      align-items: center;
      padding: 18px 20px;
      border-bottom: 1px solid var(--border);
      background: rgba(255,255,255,.65);
    }
    .appHeader .left{
      display:flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .kpi{
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
      background: rgba(255,255,255,.7);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 8px 10px;
      max-width: min(640px, 78vw);
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .appBody{ padding: 18px 20px 20px; }
    .toolbar{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 14px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .toolbar .controls{ display:flex; align-items:center; gap:10px; flex-wrap: wrap; }
    .toggle{
      display:flex;
      gap:10px;
      align-items:center;
      font-weight: 800;
      color: var(--ink-soft);
      user-select: none;
    }
    .toggle input{ width: 16px; height: 16px; }
    .gridWrap{
      border: 1px solid var(--border);
      border-radius: 18px;
      overflow: hidden;
      background: rgba(255,255,255,.9);
      box-shadow: var(--shadow-soft);
    }
    #grid{
      width: 100%;
      min-height: 360px;
    }
    .small{ font-size: 12px; color: var(--muted); margin-top: 8px; }
  </style>

  <!-- Handsontable (Excel-like grid) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.4.0/dist/handsontable.min.css">
</head>
<body>
  <div class="bg"></div>

  <div class="topbar">
    <div class="brand">
      <div class="logo">D</div>
      <div>Data input</div>
    </div>
    <div class="chips">
      <div class="chip" id="chipProject"><strong>Project:</strong> <span class="mono" id="chipProjectVal"></span></div>
      <div class="chip" id="chipTable"><strong>Table:</strong> <span class="mono" id="chipTableVal"></span></div>
      <div class="chip" id="chipAuth">Not signed in</div>
    </div>
  </div>

  <div class="wrap">

    <!-- AUTH VIEW -->
    <div class="heroGrid" id="authView">
      <div class="card">
        <div class="cardInner">
          <div class="pill">Paste Excel · Save to Supabase</div>
          <div class="big">Process.<br/>Upload.<br/>Own your data.</div>
          <div class="lead">
            Sign in to upload spreadsheet-style tables straight into Supabase.
            Use dataset names like <strong>Reporting_structure</strong>, <strong>Financial_data</strong>, or <strong>HR_data</strong>
            so you can load/overwrite each dataset independently.
          </div>
          <div class="note">
            <strong>Tip:</strong> If Sign up requires email confirmation, you can temporarily turn it off in
            <strong>Authentication → Sign in / Providers → Email</strong> (Confirm email).
          </div>
          <div class="pill" style="margin-top:12px">Secure via Supabase Auth</div>
        </div>
      </div>

      <div class="card">
        <div class="cardInner">
          <div class="authTitle">Sign in</div>

          <div class="grid2">
            <div>
              <label for="email">Email</label>
              <input id="email" type="email" autocomplete="email" placeholder="you@company.com" />
            </div>
            <div>
              <label for="password">Password</label>
              <input id="password" type="password" autocomplete="current-password" placeholder="••••••••" />
            </div>
          </div>

          <div class="btnRow">
            <button class="btn primary" id="btnSignIn" type="button">Sign in</button>
            <button class="btn" id="btnSignUp" type="button">Sign up</button>
            <button class="btn" id="btnTest" type="button">Test Supabase connection</button>
          </div>

          <div class="hint">After signing in, you’ll be taken to the upload screen.</div>
          <div class="alert" id="authAlert"></div>
        </div>
      </div>
    </div>

    <!-- APP VIEW -->
    <div class="card appShell" id="appView">
      <div class="appHeader">
        <div class="left">
          <div class="pill">Upload</div>
          <div class="kpi" id="whoami">Signed in</div>
        </div>
        <div class="btnRow" style="margin-top:0">
          <button class="btn" id="btnSignOut" type="button">Sign out</button>
        </div>
      </div>

      <div class="appBody">
        <div class="toolbar">
          <div class="controls">
            <div>
              <label for="dataset">Dataset name</label>
              <input id="dataset" type="text" value="Reporting_structure" />
              <div class="small">Used for Load/Overwrite. Saved into DB column <span style="font-family:var(--mono)">dataset</span>.</div>
            </div>
            <div class="toggle" style="margin-top:22px">
              <input id="overwrite" type="checkbox" checked />
              <span>Overwrite my latest (same dataset)</span>
            </div>
          </div>

          <div class="btnRow" style="margin-top:0">
            <button class="btn" id="btnDownloadCsv" type="button">Download CSV</button>
            <button class="btn primary" id="btnSave" type="button">Save to Supabase</button>
            <button class="btn" id="btnLoadLatest" type="button">Load my latest (same dataset)</button>
            <button class="btn" id="btnCopyJson" type="button">Copy my latest JSON</button>
            <button class="btn" id="btnClear" type="button">Clear grid</button>
          </div>
        </div>

        <div class="small">Tip: click a cell, then paste (Ctrl/Cmd+V). You can paste many cells at once.</div>

        <div class="gridWrap" style="margin-top:12px">
          <div id="grid"></div>
        </div>

        <div class="alert" id="appAlert"></div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/handsontable@14.4.0/dist/handsontable.min.js"></script>

  <script>
    /************************************************************
     * CONFIG — keep these in sync with your Supabase project
     ************************************************************/
    const SUPABASE_URL = "https://bfvidvslxcofuaoylhli.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_mLe7GSD1JP-1tYK1k09ZQg_mLydwaON"; // <-- IMPORTANT: replace with your anon key
    const TABLE_NAME = "grid_uploads";                    // <-- your table
    const DATASET_COLUMN = "dataset";                     // <-- add this column in Supabase (text) for multi-datasets

    // Dashboard display
    document.getElementById("chipProjectVal").textContent = SUPABASE_URL;
    document.getElementById("chipTableVal").textContent = TABLE_NAME;

    /************************************************************
     * Minimal Supabase Auth + PostgREST (no supabase-js dependency)
     * This avoids AbortError issues caused by blocked ESM/CDN imports.
     ************************************************************/
    const LS_KEY = "di_session_v1";

    function setChipAuth(text){ document.getElementById("chipAuth").textContent = text; }
    function showAlert(el, msg, ok=false){
      el.textContent = msg;
      el.classList.toggle("ok", !!ok);
      el.style.display = "block";
    }
    function hideAlert(el){ el.style.display = "none"; el.textContent = ""; el.classList.remove("ok"); }

    function normalizeDataset(s){
      return (s || "default")
        .trim()
        .replace(/\s+/g, "_")
        .replace(/[^\w\-]/g, "_")
        .slice(0, 80) || "default";
    }

    function loadSession(){
      try{ return JSON.parse(localStorage.getItem(LS_KEY) || "null"); }catch{ return null; }
    }
    function saveSession(s){ localStorage.setItem(LS_KEY, JSON.stringify(s)); }
    function clearSession(){ localStorage.removeItem(LS_KEY); }

    function nowSec(){ return Math.floor(Date.now()/1000); }

    async function authRequest(path, { method="GET", body=null, token=null } = {}){
      const headers = {
        "apikey": SUPABASE_ANON_KEY,
        "Content-Type": "application/json"
      };
      if(token) headers["Authorization"] = "Bearer " + token;

      const res = await fetch(SUPABASE_URL + path, {
        method,
        headers,
        body: body ? JSON.stringify(body) : undefined
      });

      const text = await res.text();
      let json = null;
      try{ json = text ? JSON.parse(text) : null; }catch{ json = null; }

      if(!res.ok){
        const msg = (json && (json.error_description || json.msg || json.message || json.error)) || (text || res.statusText);
        throw new Error(msg);
      }
      return json;
    }

    async function signUp(email, password){
      // https://supabase.com/docs/reference/javascript/auth-signup
      return authRequest("/auth/v1/signup", {
        method: "POST",
        body: { email, password }
      });
    }

    async function signIn(email, password){
      // Password grant
      const data = await authRequest("/auth/v1/token?grant_type=password", {
        method: "POST",
        body: { email, password }
      });

      // data: { access_token, refresh_token, expires_in, token_type, user }
      const session = {
        access_token: data.access_token,
        refresh_token: data.refresh_token,
        expires_at: nowSec() + (data.expires_in || 3600),
        user: data.user
      };
      saveSession(session);
      return session;
    }

    async function refreshSession(session){
      const data = await authRequest("/auth/v1/token?grant_type=refresh_token", {
        method: "POST",
        body: { refresh_token: session.refresh_token }
      });
      const next = {
        access_token: data.access_token,
        refresh_token: data.refresh_token || session.refresh_token,
        expires_at: nowSec() + (data.expires_in || 3600),
        user: data.user || session.user
      };
      saveSession(next);
      return next;
    }

    async function getValidSession(){
      let s = loadSession();
      if(!s) return null;
      // refresh if expiring in next 60s
      if((s.expires_at || 0) < nowSec() + 60){
        try{ s = await refreshSession(s); }
        catch(e){ clearSession(); throw e; }
      }
      return s;
    }

    async function postgrest(path, { method="GET", token=null, body=null, prefer=null } = {}){
      const headers = {
        "apikey": SUPABASE_ANON_KEY,
        "Content-Type": "application/json"
      };
      if(token) headers["Authorization"] = "Bearer " + token;
      if(prefer) headers["Prefer"] = prefer;

      const res = await fetch(SUPABASE_URL + "/rest/v1/" + path, {
        method,
        headers,
        body: body ? JSON.stringify(body) : undefined
      });

      const text = await res.text();
      let json = null;
      try{ json = text ? JSON.parse(text) : null; }catch{ json = null; }

      if(!res.ok){
        const msg = (json && (json.message || json.error || json.hint || json.details)) || (text || res.statusText);
        throw new Error(msg);
      }
      return json;
    }

    /************************************************************
     * UI logic
     ************************************************************/
    const authView = document.getElementById("authView");
    const appView  = document.getElementById("appView");
    const authAlert = document.getElementById("authAlert");
    const appAlert  = document.getElementById("appAlert");
    const whoami    = document.getElementById("whoami");

    function showAuth(){
      authView.style.display = "grid";
      appView.style.display = "none";
      setChipAuth("Not signed in");
    }
    function showApp(session){
      authView.style.display = "none";
      appView.style.display = "block";
      const email = session?.user?.email || "Signed in";
      setChipAuth(email);
      whoami.textContent = "Signed in as " + email;
    }

    function setBusy(btn, busy){
      btn.disabled = !!busy;
      btn.dataset._t = btn.dataset._t || btn.textContent;
      btn.textContent = busy ? "Working…" : btn.dataset._t;
    }

    /************************************************************
     * Handsontable grid
     ************************************************************/
    const container = document.getElementById("grid");
    const hot = new Handsontable(container, {
      data: Array.from({length: 20}, () => Array.from({length: 12}, () => "")),
      rowHeaders: true,
      colHeaders: true,
      contextMenu: true,
      dropdownMenu: true,
      manualColumnResize: true,
      manualRowResize: true,
      stretchH: "all",
      licenseKey: "non-commercial-and-evaluation"
    });

    function gridToRows(){
      const data = hot.getData();
      // trim trailing empty rows
      let lastNonEmptyRow = -1;
      for(let r=0; r<data.length; r++){
        if(data[r].some(v => String(v ?? "").trim() !== "")) lastNonEmptyRow = r;
      }
      const trimmed = data.slice(0, lastNonEmptyRow + 1);
      return trimmed;
    }

    function setGrid(rows){
      if(!rows || !rows.length){
        hot.loadData(Array.from({length: 20}, () => Array.from({length: 12}, () => "")));
        return;
      }
      // Ensure at least 20 rows for comfort
      const width = Math.max(...rows.map(r => r.length), 12);
      const normalized = rows.map(r => {
        const rr = Array.from({length: width}, (_, i) => (r[i] ?? ""));
        return rr;
      });
      while(normalized.length < 20) normalized.push(Array.from({length: width}, () => ""));
      hot.loadData(normalized);
    }

    /************************************************************
     * Data operations
     ************************************************************/
    async function getLatestRowId(session, dataset){
      // select id, rows for this user+dataset, latest only
      const ds = encodeURIComponent(dataset);
      const uid = encodeURIComponent(session.user.id);

      const select = encodeURIComponent("id,created_at,rows");
      const url = `${TABLE_NAME}?select=${select}&user_id=eq.${uid}&${DATASET_COLUMN}=eq.${ds}&order=created_at.desc&limit=1`;
      const res = await postgrest(url, { method:"GET", token: session.access_token });
      return res && res.length ? res[0] : null;
    }

    async function deleteRowById(session, id){
      const url = `${TABLE_NAME}?id=eq.${encodeURIComponent(id)}`;
      await postgrest(url, { method:"DELETE", token: session.access_token, prefer: "return=minimal" });
    }

    async function insertRows(session, dataset, rows){
      const payload = {
        user_id: session.user.id,
        [DATASET_COLUMN]: dataset,
        rows: rows
      };
      const url = `${TABLE_NAME}`;
      const res = await postgrest(url, { method:"POST", token: session.access_token, body: payload, prefer: "return=representation" });
      return res;
    }

    /************************************************************
     * Buttons
     ************************************************************/
    document.getElementById("btnTest").addEventListener("click", async () => {
      hideAlert(authAlert);
      const btn = document.getElementById("btnTest");
      setBusy(btn, true);
      try{
        // Health endpoint doesn't require auth; proves URL + key are valid and reachable
        await authRequest("/auth/v1/health", { method:"GET" });
        showAlert(authAlert, "Connection OK.", true);
      }catch(e){
        showAlert(authAlert, "Connection failed: " + e.message);
      }finally{
        setBusy(btn, false);
      }
    });

    document.getElementById("btnSignUp").addEventListener("click", async () => {
      hideAlert(authAlert);
      const email = (document.getElementById("email").value || "").trim();
      const pass  = (document.getElementById("password").value || "").trim();
      const btn = document.getElementById("btnSignUp");
      setBusy(btn, true);
      try{
        if(!email || !pass) throw new Error("Enter email + password.");
        await signUp(email, pass);
        showAlert(authAlert, "Sign-up OK. If email confirmation is enabled, confirm via email, then sign in.", true);
      }catch(e){
        showAlert(authAlert, e.message);
      }finally{
        setBusy(btn, false);
      }
    });

    document.getElementById("btnSignIn").addEventListener("click", async () => {
      hideAlert(authAlert);
      const email = (document.getElementById("email").value || "").trim();
      const pass  = (document.getElementById("password").value || "").trim();
      const btn = document.getElementById("btnSignIn");
      setBusy(btn, true);
      try{
        if(!email || !pass) throw new Error("Enter email + password.");
        const session = await signIn(email, pass);
        showApp(session);
        showAlert(appAlert, "Signed in successfully.", true);
      }catch(e){
        showAlert(authAlert, e.message);
      }finally{
        setBusy(btn, false);
      }
    });

    document.getElementById("btnSignOut").addEventListener("click", async () => {
      hideAlert(appAlert);
      clearSession();
      showAuth();
      showAlert(authAlert, "Signed out.", true);
    });

    document.getElementById("btnClear").addEventListener("click", () => {
      hideAlert(appAlert);
      setGrid([]);
      showAlert(appAlert, "Cleared.", true);
    });

    document.getElementById("btnCopyJson").addEventListener("click", async () => {
      hideAlert(appAlert);
      const btn = document.getElementById("btnCopyJson");
      setBusy(btn, true);
      try{
        const session = await getValidSession();
        if(!session) throw new Error("Not signed in.");
        const dataset = normalizeDataset(document.getElementById("dataset").value);
        const latest = await getLatestRowId(session, dataset);
        const rows = latest?.rows ?? [];
        await navigator.clipboard.writeText(JSON.stringify(rows));
        showAlert(appAlert, "Copied latest JSON (same dataset) to clipboard.", true);
      }catch(e){
        showAlert(appAlert, e.message);
      }finally{
        setBusy(btn, false);
      }
    });

    document.getElementById("btnLoadLatest").addEventListener("click", async () => {
      hideAlert(appAlert);
      const btn = document.getElementById("btnLoadLatest");
      setBusy(btn, true);
      try{
        const session = await getValidSession();
        if(!session) throw new Error("Not signed in.");
        const dataset = normalizeDataset(document.getElementById("dataset").value);
        const latest = await getLatestRowId(session, dataset);
        if(!latest) throw new Error("No uploads found for this dataset.");
        setGrid(latest.rows || []);
        showAlert(appAlert, "Loaded latest upload for dataset: " + dataset, true);
      }catch(e){
        showAlert(appAlert, e.message);
      }finally{
        setBusy(btn, false);
      }
    });

    document.getElementById("btnDownloadCsv").addEventListener("click", () => {
      hideAlert(appAlert);
      const rows = gridToRows();
      const csv = rows.map(r => r.map(v => {
        const s = String(v ?? "");
        return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(",")).join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "grid.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

    document.getElementById("btnSave").addEventListener("click", async () => {
      hideAlert(appAlert);
      const btn = document.getElementById("btnSave");
      setBusy(btn, true);
      try{
        const session = await getValidSession();
        if(!session) throw new Error("Not signed in.");
        const dataset = normalizeDataset(document.getElementById("dataset").value);
        const overwrite = document.getElementById("overwrite").checked;
        const rows = gridToRows();
        if(!rows.length) throw new Error("Grid is empty.");

        if(overwrite){
          const latest = await getLatestRowId(session, dataset);
          if(latest?.id){
            await deleteRowById(session, latest.id);
          }
        }
        await insertRows(session, dataset, rows);
        showAlert(appAlert, overwrite ? "Saved (overwrite mode: replaced latest for this dataset)." : "Saved.", true);
      }catch(e){
        showAlert(appAlert, e.message);
      }finally{
        setBusy(btn, false);
      }
    });

    /************************************************************
     * Boot
     ************************************************************/
    (function init(){
      // Basic sanity check for config
      if(!SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.includes("PASTE_YOUR_ANON_KEY_HERE")){
        showAlert(authAlert, "Set your SUPABASE_ANON_KEY in the HTML, then reload.");
      }
      // Resume session if present
      const s = loadSession();
      if(s && s.user){
        showApp(s);
      }else{
        showAuth();
      }
    })();
  </script>
</body>
</html>
