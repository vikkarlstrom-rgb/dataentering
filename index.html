<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Data input • Excel Paste Grid</title>

  <!-- Handsontable Community Edition (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.5.0/dist/handsontable.full.min.css">
  <script src="https://cdn.jsdelivr.net/npm/handsontable@14.5.0/dist/handsontable.full.min.js"></script>

  <style>
    :root {
      --bg1: #f3f5ff;
      --bg2: #ffe7f6;
      --bg3: #e6fff7;
      --ink: #0b0f1a;
      --muted: rgba(11, 15, 26, .65);
      --card: rgba(255,255,255,.72);
      --border: rgba(11, 15, 26, .12);
      --shadow: 0 18px 60px rgba(11, 15, 26, .12);
      --shadow2: 0 10px 30px rgba(11, 15, 26, .10);
      --btn: #0b0f1a;
      --btnInk: #fff;
      --btnGhost: rgba(11, 15, 26, .06);
      --okBg: rgba(16, 185, 129, .14);
      --okBorder: rgba(16, 185, 129, .35);
      --errBg: rgba(239, 68, 68, .12);
      --errBorder: rgba(239, 68, 68, .32);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--ink);
      background:
        radial-gradient(1100px 600px at 15% 20%, var(--bg2), transparent 65%),
        radial-gradient(900px 550px at 75% 30%, var(--bg1), transparent 70%),
        radial-gradient(900px 650px at 55% 95%, var(--bg3), transparent 65%),
        #fbfbff;
      min-height: 100vh;
    }

    .topbar {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(14px);
      background: rgba(255,255,255,.55);
      border-bottom: 1px solid var(--border);
    }
    .topbar-inner {
      max-width: 1180px;
      margin: 0 auto;
      padding: 14px 18px;
      display: flex;
      align-items: center;
      gap: 14px;
      justify-content: space-between;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 800;
      letter-spacing: -0.02em;
    }
    .brand-badge {
      width: 34px; height: 34px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(0,0,0,.95), rgba(0,0,0,.75));
      color: #fff;
      display: grid;
      place-items: center;
      box-shadow: var(--shadow2);
      font-weight: 900;
    }
    .topbar-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--muted);
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.7);
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 13px;
      color: var(--muted);
      max-width: 360px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .wrap {
      max-width: 1180px;
      margin: 0 auto;
      padding: 26px 18px 40px;
    }

    .grid2 {
      display: grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 22px;
      align-items: stretch;
    }
    @media (max-width: 980px) {
      .grid2 { grid-template-columns: 1fr; }
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 22px;
      box-shadow: var(--shadow);
    }
    .card-inner { padding: 22px; }

    .hero {
      padding: 34px 28px;
      min-height: 420px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .hero h1 {
      font-size: clamp(42px, 4.6vw, 64px);
      line-height: .92;
      letter-spacing: -0.04em;
      margin: 0 0 14px;
    }
    .hero p {
      margin: 0;
      color: var(--muted);
      font-size: 16px;
      line-height: 1.6;
      max-width: 52ch;
    }
    .hero-note {
      margin-top: 20px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.6);
      color: var(--muted);
      font-size: 13px;
    }

    .auth-card .title {
      font-weight: 800;
      letter-spacing: -0.02em;
      margin: 0 0 10px;
      font-size: 18px;
    }
    .field-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 520px) {
      .field-row { grid-template-columns: 1fr; }
    }

    label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin: 10px 0 6px;
    }
    input[type="email"], input[type="password"], input[type="text"] {
      width: 100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.75);
      outline: none;
      font-size: 14px;
    }
    input:focus {
      border-color: rgba(11,15,26,.28);
      box-shadow: 0 0 0 4px rgba(11,15,26,.06);
    }

    .btn-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    button {
      border: 1px solid var(--border);
      background: rgba(255,255,255,.7);
      color: var(--ink);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 650;
      cursor: pointer;
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
    }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0px); }
    button.primary {
      background: var(--btn);
      color: var(--btnInk);
      border-color: rgba(11,15,26,.15);
    }
    button.ghost { background: var(--btnGhost); }
    button[disabled] { opacity: .55; cursor: not-allowed; transform: none; }

    .app-head {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 14px;
      flex-wrap: wrap;
      margin-bottom: 14px;
    }
    .app-title { margin: 0; font-size: 22px; letter-spacing: -0.02em; }
    .app-sub { margin: 6px 0 0; font-size: 13px; color: var(--muted); }

    .toolbar {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 14px;
      align-items: end;
      margin: 10px 0 14px;
    }
    @media (max-width: 820px) {
      .toolbar { grid-template-columns: 1fr; }
    }
    .toolbar-left {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-items: end;
    }
    @media (max-width: 520px) {
      .toolbar-left { grid-template-columns: 1fr; }
    }
    .inline {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: var(--muted);
      user-select: none;
    }
    .toggle input {
      width: 18px;
      height: 18px;
      accent-color: #0b0f1a;
    }
    .hint { margin: 10px 0 0; color: var(--muted); font-size: 13px; }

    #grid {
      width: 100%;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.65);
    }

    .msg {
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.6);
      color: var(--muted);
      font-size: 14px;
    }
    #okBox {
      display: none;
      background: var(--okBg);
      border-color: var(--okBorder);
      color: rgba(6, 95, 70, 1);
      font-weight: 650;
    }
    #errorBox {
      display: none;
      background: var(--errBg);
      border-color: var(--errBorder);
      color: rgba(153, 27, 27, 1);
      font-weight: 650;
    }
    .hidden { display: none !important; }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="brand-badge">D</div>
        <div>Data input</div>
      </div>
      <div class="topbar-meta">
        <span class="pill">Project: https://bfvidvslxcofuaoylhli.supabase.co • Table: <b>grid_uploads</b></span>
        <span class="pill" id="whoami">Not signed in</span>
      </div>
    </div>
  </div>

  <div class="wrap">
    <section id="authView" class="grid2">
      <div class="card hero">
        <div>
          <div class="pill" style="width:fit-content; margin-bottom:14px;">Paste Excel • Save to Supabase</div>
          <h1>Process.<br/>Upload.<br/>Own your data.</h1>
          <p>
            Sign in to upload spreadsheet-style tables straight into Supabase.
            Use dataset names like <b>Reporting_structure</b>, <b>Financial_data</b>, or <b>HR_data</b>
            so you can load/overwrite each dataset independently.
          </p>
          <div class="hero-note">
            Tip: If Sign up requires email confirmation, turn it off temporarily in
            <b>Authentication → Sign in / Providers → Email</b> (Confirm email).
          </div>
        </div>
        <div class="pill" style="width:fit-content;">Secure via Supabase Auth</div>
      </div>

      <div class="card auth-card">
        <div class="card-inner">
          <div class="title">Sign in</div>

          <div class="field-row">
            <div>
              <label>Email</label>
              <input id="email" type="email" placeholder="you@company.com" autocomplete="username" />
            </div>
            <div>
              <label>Password</label>
              <input id="password" type="password" placeholder="••••••••" autocomplete="current-password" />
            </div>
          </div>

          <div class="btn-row">
            <button type="button" id="signInBtn" class="primary">Sign in</button>
            <button type="button" id="signUpBtn" class="ghost">Sign up</button>
            <button type="button" id="testConnBtn">Test Supabase connection</button>
          </div>

          <div class="hint">After signing in, you’ll be taken to the upload screen.</div>

          <div id="okBox" class="msg"></div>
          <div id="errorBox" class="msg"></div>
        </div>
      </div>
    </section>

    <section id="appView" class="hidden">
      <div class="card">
        <div class="card-inner">
          <div class="app-head">
            <div>
              <h2 class="app-title">Upload</h2>
              <p class="app-sub">Paste from Excel into the grid, then save into Supabase.</p>
            </div>
            <div class="inline">
              <button type="button" id="signOutBtn" class="ghost">Sign out</button>
            </div>
          </div>

          <div class="toolbar">
            <div class="toolbar-left">
              <div>
                <label>Dataset name</label>
                <input id="datasetName" type="text" value="Reporting_structure" />
                <div class="hint">Used for Load/Overwrite. Saved into DB column <b>dataset</b>.</div>
              </div>
              <div>
                <label>Actions</label>
                <div class="inline">
                  <button type="button" id="downloadCsv">Download CSV</button>
                  <button type="button" id="saveDb" class="primary">Save to Supabase</button>
                </div>
                <div class="inline" style="margin-top:10px;">
                  <label class="toggle"><input id="overwriteToggle" type="checkbox" /> Overwrite my latest (same dataset)</label>
                  <button type="button" id="loadDb" class="ghost">Load my latest (same dataset)</button>
                  <button type="button" id="copyJson" class="ghost">Copy my latest JSON</button>
                  <button type="button" id="clearGrid">Clear grid</button>
                </div>
              </div>
            </div>

            <div>
              <div id="status" class="hint"></div>
            </div>
          </div>

          <div class="hint">Tip: click a cell, then paste (Ctrl/Cmd+V). You can paste many cells at once.</div>
          <div id="grid" style="margin-top:12px;"></div>

          <div id="okBoxApp" class="msg" style="display:none; background: var(--okBg); border-color: var(--okBorder); color: rgba(6,95,70,1); font-weight:650;"></div>
          <div id="errorBoxApp" class="msg" style="display:none; background: var(--errBg); border-color: var(--errBorder); color: rgba(153,27,27,1); font-weight:650;"></div>
        </div>
      </div>
    </section>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://bfvidvslxcofuaoylhli.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_mLe7GSD1JP-1tYK1k09ZQg_mLydwaON";
    const TABLE_NAME = "grid_uploads";

    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const authView = document.getElementById("authView");
    const appView  = document.getElementById("appView");

    const emailEl = document.getElementById("email");
    const passEl  = document.getElementById("password");
    const datasetEl = document.getElementById("datasetName");

    const whoamiEl = document.getElementById("whoami");
    const statusEl = document.getElementById("status");

    const okBoxAuth = document.getElementById("okBox");
    const errBoxAuth = document.getElementById("errorBox");
    const okBoxApp = document.getElementById("okBoxApp");
    const errBoxApp = document.getElementById("errorBoxApp");

    function showAuthMsg(type, msg) {
      okBoxAuth.style.display = "none";
      errBoxAuth.style.display = "none";
      if (!msg) return;
      if (type === "ok") {
        okBoxAuth.textContent = msg;
        okBoxAuth.style.display = "block";
      } else {
        errBoxAuth.textContent = msg;
        errBoxAuth.style.display = "block";
      }
    }

    function showAppMsg(type, msg) {
      okBoxApp.style.display = "none";
      errBoxApp.style.display = "none";
      if (!msg) return;
      if (type === "ok") {
        okBoxApp.textContent = msg;
        okBoxApp.style.display = "block";
      } else {
        errBoxApp.textContent = msg;
        errBoxApp.style.display = "block";
      }
    }

    function setOk(msg) {
      if (!appView.classList.contains("hidden")) showAppMsg("ok", msg);
      else showAuthMsg("ok", msg);
    }
    function setErr(msg) {
      if (!appView.classList.contains("hidden")) showAppMsg("err", msg);
      else showAuthMsg("err", msg);
    }
    function setStatus(msg) {
      statusEl.textContent = msg || "";
    }

    function getDatasetName() {
      const v = (datasetEl?.value || "").trim();
      return v || "default";
    }

    function rowsFromGrid() {
      return hot.getData();
    }

    function rowsToCSV(rows) {
      return rows.map(r => r.map(cell => {
        const s = (cell ?? "").toString();
        const escaped = s.includes('"') ? s.replaceAll('"','""') : s;
        if (/[",\n\r]/.test(escaped)) return `"${escaped}"`;
        return escaped;
      }).join(",")).join("\n");
    }

    async function requireUser() {
      const { data, error } = await sb.auth.getUser();
      if (error) throw error;
      if (!data.user) throw new Error("Not signed in.");
      return data.user;
    }

    async function refreshAuthUI() {
      try {
        // Prefer session (fast + reliable) then user
        const { data: sessData, error: sessErr } = await sb.auth.getSession();
        if (sessErr) console.warn("getSession error:", sessErr);

        const session = sessData?.session || null;
        const email = session?.user?.email || "";

        if (session && session.user) {
          whoamiPill.textContent = email || "Signed in";
          whoamiPill.classList.add("ok");
          signOutBtn.style.display = "inline-block";
          signInBtn.style.display = "none";
          signUpBtn.style.display = "none";
          authOk.style.display = "none";
          authErr.style.display = "none";

          // Switch screens
          authScreen.style.display = "none";
          appScreen.style.display = "block";

          // If email is unconfirmed, warn (shouldn't happen if session exists)
          if (session.user.email_confirmed_at == null && session.user.confirmed_at == null) {
            showOk("Signed in, but email appears unconfirmed. If anything fails, confirm email in Supabase Auth → Users.");
          }
          return;
        }

        // Not signed in
        whoamiPill.textContent = "Not signed in";
        whoamiPill.classList.remove("ok");
        signOutBtn.style.display = "none";
        signInBtn.style.display = "inline-block";
        signUpBtn.style.display = "inline-block";

        authScreen.style.display = "block";
        appScreen.style.display = "none";
      } catch (e) {
        console.error(e);
        showAuthMsg("err", "Auth UI error: " + (e?.message || e));
      }
    }

    // --- Auth
    document.getElementById("signUpBtn").addEventListener("click", async () => {
      const email = emailEl.value.trim();
      const password = passEl.value;
      if (!email || !password) return showAuthMsg("err", "Enter email + password");

      showAuthMsg("ok", "Creating account…");
      try {
        const { data, error } = await sb.auth.signUp({ email, password });
        if (error) return showAuthMsg("err", error.message);

        // If confirm-email is enabled, Supabase will create the user but block sign-in until confirmed.
        const needsConfirm = !data?.session;
        if (needsConfirm) {
          showAuthMsg("ok", "Sign-up OK. Check your inbox to confirm email, then sign in. (Or temporarily disable: Auth → Sign in / Providers → Email → Confirm email)");
        } else {
          showAuthMsg("ok", "Signed up + signed in ✅");
          await refreshAuthUI();
        }
      } catch (e) {
        console.error(e);
        showAuthMsg("err", e?.message || String(e));
      }
    });

    document.getElementById("signInBtn").addEventListener("click", async () => {
      const email = emailEl.value.trim();
      const password = passEl.value;
      if (!email || !password) return showAuthMsg("err", "Enter email + password");

      showAuthMsg("ok", "Signing in…");
      try {
        // Do not hard-fail on a timer (can false-trigger on slow networks / cold starts).
        // Instead, show a "still working" hint after 10s while we keep waiting.
        let slowTimer = setTimeout(() => {
          showAuthMsg("ok", "Still signing in… (if this keeps happening, disable blockers for supabase.co / jsdelivr.net)");
        }, 10000);

        const { data, error } = await sb.auth.signInWithPassword({ email, password });
        clearTimeout(slowTimer);

        if (error) {
          const msg = String(error.message || error);
          if (msg.toLowerCase().includes("email") && msg.toLowerCase().includes("confirm")) {
            return showAuthMsg(
              "err",
              msg + " (Confirm in Supabase Auth → Users, or disable confirm-email temporarily.)"
            );
          }
          return showAuthMsg("err", msg);
        }

        // success
        showAuthMsg("ok", "Signed in ✅");
        await refreshAuthUI();
      } catch (e) {
        console.error(e);
        showAuthMsg("err", e?.message || String(e));
      }
    });

    document.getElementById("signOutBtn").addEventListener("click", async () => {
      try {
        await sb.auth.signOut();
        setOk("Signed out.");
        await refreshAuthUI();
      } catch (e) {
        setErr(e.message || String(e));
      }
    });

    document.getElementById("testConnBtn").addEventListener("click", async () => {
      try {
        showAuthMsg("err", "");
        showAuthMsg("ok", "");
        const { error } = await sb.from(TABLE_NAME).select("id").limit(1);
        if (error) throw error;
        setOk("✅ Connection OK.");
      } catch (e) {
        setErr(e.message || String(e));
      }
    });

    // --- Handsontable
    const container = document.getElementById("grid");
    const hot = new Handsontable(container, {
      data: Array.from({ length: 20 }, () => Array.from({ length: 12 }, () => "")),
      rowHeaders: true,
      colHeaders: true,
      contextMenu: true,
      dropdownMenu: true,
      licenseKey: "non-commercial-and-evaluation",
      manualColumnResize: true,
      manualRowResize: true,
      minSpareRows: 1,
      minSpareCols: 1,
    });

    // --- CSV download
    document.getElementById("downloadCsv").addEventListener("click", () => {
      const csv = rowsToCSV(rowsFromGrid());
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${getDatasetName()}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    // --- Save / Load helpers
    async function getLatestRowIdForUserAndDataset(userId, dataset) {
      const { data, error } = await sb
        .from(TABLE_NAME)
        .select("id")
        .eq("user_id", userId)
        .eq("dataset", dataset)
        .order("created_at", { ascending: false })
        .limit(1);
      if (error) throw error;
      return data?.[0]?.id || null;
    }

    document.getElementById("saveDb").addEventListener("click", async () => {
      try {
        setStatus("");
        showAppMsg("err", "");
        showAppMsg("ok", "");

        const user = await requireUser();
        const dataset = getDatasetName();
        const overwrite = document.getElementById("overwriteToggle").checked;

        const rows = rowsFromGrid();
        const payload = { user_id: user.id, dataset, rows };

        setStatus(overwrite ? "Overwriting latest…" : "Saving…");

        if (overwrite) {
          const latestId = await getLatestRowIdForUserAndDataset(user.id, dataset);
          if (latestId) {
            const { error: delErr } = await sb.from(TABLE_NAME).delete().eq("id", latestId);
            if (delErr) throw delErr;
          }
        }

        const { error: insErr } = await sb.from(TABLE_NAME).insert(payload);
        if (insErr) throw insErr;

        setStatus("");
        setOk(overwrite ? "✅ Overwrote latest dataset successfully." : "✅ Saved.");
      } catch (e) {
        setStatus("");
        setErr(e.message || String(e));
      }
    });

    document.getElementById("loadDb").addEventListener("click", async () => {
      try {
        showAppMsg("err", "");
        showAppMsg("ok", "");
        const user = await requireUser();
        const dataset = getDatasetName();
        setStatus("Loading latest…");
        const { data, error } = await sb
          .from(TABLE_NAME)
          .select("rows")
          .eq("user_id", user.id)
          .eq("dataset", dataset)
          .order("created_at", { ascending: false })
          .limit(1);
        if (error) throw error;
        const rows = data?.[0]?.rows;
        if (!rows) throw new Error("No saved data found for this dataset.");
        hot.loadData(rows);
        setStatus("");
        setOk("✅ Loaded latest.");
      } catch (e) {
        setStatus("");
        setErr(e.message || String(e));
      }
    });

    document.getElementById("copyJson").addEventListener("click", async () => {
      try {
        showAppMsg("err", "");
        showAppMsg("ok", "");
        const user = await requireUser();
        const dataset = getDatasetName();
        setStatus("Fetching…");
        const { data, error } = await sb
          .from(TABLE_NAME)
          .select("rows")
          .eq("user_id", user.id)
          .eq("dataset", dataset)
          .order("created_at", { ascending: false })
          .limit(1);
        if (error) throw error;
        const rows = data?.[0]?.rows;
        if (!rows) throw new Error("No saved data found for this dataset.");
        await navigator.clipboard.writeText(JSON.stringify(rows));
        setStatus("");
        setOk("✅ Copied JSON to clipboard.");
      } catch (e) {
        setStatus("");
        setErr(e.message || String(e));
      }
    });

    document.getElementById("clearGrid").addEventListener("click", () => {
      hot.loadData(Array.from({ length: 20 }, () => Array.from({ length: 12 }, () => "")));
      setOk("Cleared.");
    });

    sb.auth.onAuthStateChange(() => refreshAuthUI());
    await refreshAuthUI();
  </script>
</body>
</html>
