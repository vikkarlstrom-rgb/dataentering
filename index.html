<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Excel Paste Grid → CSV + Supabase Save</title>

  <!-- Handsontable Community Edition (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.5.0/dist/handsontable.full.min.css">
  <script src="https://cdn.jsdelivr.net/npm/handsontable@14.5.0/dist/handsontable.full.min.js"></script>

  <!-- Supabase JS v2 (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root { color-scheme: light; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; }
    h2 { margin-top: 0; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; margin: 10px 0; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin: 10px 0 12px; }
    button { padding: 8px 12px; cursor: pointer; }
    input { padding: 8px 10px; min-width: 220px; }
    .label { font-size: 12px; color: #555; margin-bottom: 4px; }
    .hint { color:#555; font-size: 14px; }
    #grid { width: 100%; max-width: 1200px; }
    #status { color:#444; font-size: 14px; margin-left: 6px; }
    .pill { padding: 2px 8px; border: 1px solid #ddd; border-radius: 999px; font-size: 12px; color:#333; }
    .checkbox { display:flex; gap:6px; align-items:center; font-size: 13px; color:#333; }
    .ok { margin-top: 10px; padding: 10px 12px; border: 1px solid #d0efdb; background:#f3fff6; color:#1f5f2a; border-radius: 8px; display:none; max-width: 1200px; }
    .err { margin-top: 10px; padding: 10px 12px; border: 1px solid #f3c0c0; background:#fff4f4; color:#7a1f1f; border-radius: 8px; display:none; max-width: 1200px; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; }
  </style>
</head>
<body>
  <h2>Paste from Excel into the grid</h2>

  <!-- Auth -->
  <div class="row">
    <div>
      <div class="label">Email</div>
      <input id="email" type="email" placeholder="you@company.com" autocomplete="username" />
    </div>
    <div>
      <div class="label">Password</div>
      <input id="password" type="password" placeholder="password" autocomplete="current-password" />
    </div>

    <button type="button" id="signUpBtn">Sign up</button>
    <button type="button" id="signInBtn">Sign in</button>
    <button type="button" id="signOutBtn" style="display:none;">Sign out</button>

    <button type="button" id="testConnBtn">Test Supabase connection</button>
    <span class="pill" id="whoami">Not signed in</span>
  </div>

  <!-- Actions -->
  <div class="toolbar">
    <button type="button" id="downloadCsv">Download CSV</button>

    <button type="button" id="saveDb">Save to Supabase</button>
    <label class="checkbox" title="When enabled, your latest saved row is updated instead of creating a new row.">
      <input id="overwriteLatest" type="checkbox" checked />
      Overwrite my latest
    </label>

    <button type="button" id="loadDb">Load my latest</button>
    <button type="button" id="copyLatestJson">Copy my latest JSON</button>

    <button type="button" id="clearGrid">Clear grid</button>

    <span class="hint">Tip: click a cell, then paste (Ctrl/Cmd+V). You can paste many cells at once.</span>
    <span id="status"></span>
  </div>

  <div id="grid"></div>

  <div id="okBox" class="ok"></div>
  <div id="errBox" class="err"></div>

  <!-- Main app logic -->
  <script>
    // ============================
    // 1) CONFIG
    // ============================
    const SUPABASE_URL = "https://bfvidvslxcofuaoylhli.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_mLe7GSD1JP-1tYK1k09ZQg_mLydwaON";
    const TABLE_NAME = "grid_uploads"; // must match your SQL table name

    // ============================
    // 2) HELPERS
    // ============================
    const $ = (id) => document.getElementById(id);

    function showOk(msg) {
      $("errBox").style.display = "none";
      $("okBox").textContent = msg;
      $("okBox").style.display = "block";
    }

    function showErr(msg) {
      $("okBox").style.display = "none";
      $("errBox").textContent = msg;
      $("errBox").style.display = "block";
    }

    function clearNotices() {
      $("okBox").style.display = "none";
      $("errBox").style.display = "none";
    }

    function setStatus(msg) {
      $("status").textContent = msg;
    }

    function download(filename, text) {
      const el = document.createElement("a");
      el.setAttribute("href", "data:text/plain;charset=utf-8," + encodeURIComponent(text));
      el.setAttribute("download", filename);
      el.style.display = "none";
      document.body.appendChild(el);
      el.click();
      document.body.removeChild(el);
    }

    function toCsv(data) {
      const escape = (v) => {
        const s = (v ?? "").toString();
        return /[\",\n]/.test(s) ? `"${s.replaceAll('"', '""')}"` : s;
      };
      return data.map((row) => row.map(escape).join(",")).join("\n");
    }

    function trimData(data) {
      // remove fully empty rows at end
      let lastRow = data.length - 1;
      while (lastRow >= 0 && data[lastRow].every((c) => (c ?? "").toString().trim() === "")) lastRow--;
      const trimmed = data.slice(0, lastRow + 1);

      // remove fully empty columns at end
      let lastCol = 0;
      trimmed.forEach((r) => {
        for (let i = r.length - 1; i >= 0; i--) {
          if ((r[i] ?? "").toString().trim() !== "") {
            lastCol = Math.max(lastCol, i);
            break;
          }
        }
      });
      return trimmed.map((r) => r.slice(0, lastCol + 1));
    }

    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch {
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        return true;
      }
    }

    // ============================
    // 3) INIT
    // ============================
    clearNotices();

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const initialRows = 20;
    const initialCols = 12;
    const container = $("grid");

    const hot = new Handsontable(container, {
      data: Array.from({ length: initialRows }, () => Array(initialCols).fill("")),
      rowHeaders: true,
      colHeaders: true,
      contextMenu: true,
      dropdownMenu: true,
      licenseKey: "non-commercial-and-evaluation",
      height: 460,
      width: "100%",
      stretchH: "all",
      manualColumnResize: true,
      manualRowResize: true,
      filters: true
    });

    async function refreshWhoAmI() {
      const { data: { session } } = await sb.auth.getSession();
      if (session?.user) {
        $("whoami").textContent = `Signed in: ${session.user.email}`;
        $("signOutBtn").style.display = "inline-block";
      } else {
        $("whoami").textContent = "Not signed in";
        $("signOutBtn").style.display = "none";
      }
    }

    sb.auth.onAuthStateChange(() => refreshWhoAmI());
    refreshWhoAmI();

    // ============================
    // 4) AUTH BUTTONS
    // ============================
    $("signUpBtn").addEventListener("click", async () => {
      clearNotices();
      setStatus("");
      const email = $("email").value.trim();
      const password = $("password").value;
      if (!email || !password) return alert("Enter email + password");

      setStatus("Signing up…");
      const { error } = await sb.auth.signUp({ email, password });
      setStatus("");

      if (error) return showErr(error.message);
      showOk("Sign-up OK. If email confirmation is enabled, check your inbox, then sign in.");
    });

    $("signInBtn").addEventListener("click", async () => {
      clearNotices();
      setStatus("");
      const email = $("email").value.trim();
      const password = $("password").value;
      if (!email || !password) return alert("Enter email + password");

      setStatus("Signing in…");
      const { error } = await sb.auth.signInWithPassword({ email, password });
      setStatus("");

      if (error) return showErr(error.message);
      showOk("Signed in!");
    });

    $("signOutBtn").addEventListener("click", async () => {
      clearNotices();
      setStatus("");
      const { error } = await sb.auth.signOut();
      if (error) return showErr(error.message);
      showOk("Signed out");
    });

    $("testConnBtn").addEventListener("click", async () => {
      clearNotices();
      setStatus("Testing…");
      try {
        // lightweight call
        const { error } = await sb.from(TABLE_NAME).select("id").limit(1);
        setStatus("");
        if (error) return showErr(error.message);
        showOk("Supabase connection looks good.");
      } catch (e) {
        setStatus("");
        showErr(e?.message || String(e));
      }
    });

    // ============================
    // 5) GRID ACTIONS
    // ============================
    $("downloadCsv").addEventListener("click", () => {
      clearNotices();
      setStatus("");
      const cleaned = trimData(hot.getData());
      const csv = toCsv(cleaned);
      download("data.csv", csv);
      showOk("CSV downloaded.");
    });

    $("clearGrid").addEventListener("click", () => {
      clearNotices();
      setStatus("");
      hot.loadData(Array.from({ length: initialRows }, () => Array(initialCols).fill("")));
      showOk("Grid cleared.");
    });

    async function requireUser() {
      const { data: { session } } = await sb.auth.getSession();
      if (!session?.user) {
        showErr("Please sign in first.");
        return null;
      }
      return session.user;
    }

    async function getLatestRowForUser(userId) {
      const { data, error } = await sb
        .from(TABLE_NAME)
        .select("id, created_at")
        .eq("user_id", userId)
        .order("created_at", { ascending: false })
        .limit(1);

      if (error) throw error;
      return data?.[0] || null;
    }

    $("saveDb").addEventListener("click", async () => {
      clearNotices();
      setStatus("");
      const user = await requireUser();
      if (!user) return;

      const cleaned = trimData(hot.getData());
      if (!cleaned.length) return showErr("Nothing to save (grid is empty)." );

      const overwrite = $("overwriteLatest").checked;
      setStatus(overwrite ? "Saving (overwrite)…" : "Saving (new row)…");

      try {
        if (overwrite) {
          const latest = await getLatestRowForUser(user.id);
          if (latest?.id) {
            const { error } = await sb
              .from(TABLE_NAME)
              .update({ rows: cleaned })
              .eq("id", latest.id);
            if (error) throw error;
            setStatus("");
            return showOk("Saved (updated your latest row)." );
          }
          // no previous row → insert
        }

        const { error } = await sb.from(TABLE_NAME).insert({
          user_id: user.id,
          rows: cleaned
        });
        if (error) throw error;

        setStatus("");
        showOk(overwrite ? "Saved (created your first row)." : "Saved (created a new row)." );
      } catch (e) {
        setStatus("");
        showErr(e?.message || String(e));
      }
    });

    $("loadDb").addEventListener("click", async () => {
      clearNotices();
      setStatus("");
      const user = await requireUser();
      if (!user) return;

      setStatus("Loading…");
      try {
        const { data, error } = await sb
          .from(TABLE_NAME)
          .select("rows, created_at")
          .eq("user_id", user.id)
          .order("created_at", { ascending: false })
          .limit(1);

        if (error) throw error;
        if (!data?.length) {
          setStatus("");
          return showErr("No saved uploads found for your user." );
        }

        hot.loadData(data[0].rows);
        setStatus("");
        showOk("Loaded your latest saved data." );
      } catch (e) {
        setStatus("");
        showErr(e?.message || String(e));
      }
    });

    $("copyLatestJson").addEventListener("click", async () => {
      clearNotices();
      setStatus("");
      const user = await requireUser();
      if (!user) return;

      setStatus("Fetching JSON…");
      try {
        const { data, error } = await sb
          .from(TABLE_NAME)
          .select("rows, created_at")
          .eq("user_id", user.id)
          .order("created_at", { ascending: false })
          .limit(1);

        if (error) throw error;
        if (!data?.length) {
          setStatus("");
          return showErr("No saved uploads found." );
        }

        const json = JSON.stringify(data[0].rows, null, 2);
        await copyToClipboard(json);
        setStatus("");
        showOk("Copied your latest JSON to clipboard." );
      } catch (e) {
        setStatus("");
        showErr(e?.message || String(e));
      }
    });
  </script>
</body>
</html>
