<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Excel Paste Grid → Supabase</title>

  <!-- Handsontable Community Edition (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.5.0/dist/handsontable.full.min.css">
  <script src="https://cdn.jsdelivr.net/npm/handsontable@14.5.0/dist/handsontable.full.min.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; }
    h2 { margin-top: 0; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; margin: 10px 0; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin: 10px 0 12px; }
    button { padding: 8px 12px; cursor: pointer; }
    input { padding: 8px 10px; min-width: 220px; }
    .label { font-size:12px; color:#555; margin-bottom: 4px; }
    .hint { color:#555; font-size: 14px; }
    #grid { width:100%; max-width:1200px; }
    #status { color:#444; font-size:14px; margin-left: 6px; }
    .pill { padding: 2px 8px; border: 1px solid #ddd; border-radius: 999px; font-size: 12px; color:#333; }
    .error { margin-top:10px; padding: 10px 12px; border: 1px solid #f3c0c0; background:#fff4f4; color:#7a1f1f; border-radius: 8px; display:none; max-width: 1200px; }
    .ok { margin-top:10px; padding: 10px 12px; border: 1px solid #c6edc6; background:#f3fff6; color:#145a2a; border-radius: 8px; display:none; max-width: 1200px; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; }
    .small { font-size: 12px; color:#666; }
    .inline { display:inline-flex; align-items:center; gap:8px; }
  </style>
</head>
<body>
  <h2>Paste from Excel into the grid</h2>

  <div class="small">
    Project: <code id="projUrl"></code> • Table: <code id="tableName"></code>
  </div>

  <!-- Auth -->
  <div class="row">
    <div>
      <div class="label">Email</div>
      <input id="email" type="email" placeholder="you@company.com" autocomplete="username" />
    </div>
    <div>
      <div class="label">Password</div>
      <input id="password" type="password" placeholder="password" autocomplete="current-password" />
    </div>
    <div>
      <div class="label">Dataset name</div>
      <input id="dataset" list="datasetOptions" placeholder="Reporting_structure" />
      <datalist id="datasetOptions">
        <option value="Reporting_structure"></option>
        <option value="Financial_data"></option>
        <option value="HR_data"></option>
      </datalist>
      <div class="small">Used for Load/Overwrite. Saved into the DB column <code>dataset</code>.</div>
    </div>

    <button type="button" id="signUpBtn">Sign up</button>
    <button type="button" id="signInBtn">Sign in</button>
    <button type="button" id="signOutBtn" style="display:none;">Sign out</button>

    <button type="button" id="testConnBtn">Test Supabase connection</button>
    <span class="pill" id="whoami">Not signed in</span>
  </div>

  <!-- Actions -->
  <div class="toolbar">
    <button type="button" id="downloadCsv">Download CSV</button>
    <button type="button" id="saveDb">Save to Supabase</button>

    <label class="inline">
      <input type="checkbox" id="overwriteLatest" />
      <span>Overwrite my latest (same dataset)</span>
    </label>

    <button type="button" id="loadDb">Load my latest (same dataset)</button>
    <button type="button" id="copyJson">Copy my latest JSON</button>
    <button type="button" id="clearGrid">Clear grid</button>

    <span class="hint">Tip: click a cell, then paste (Ctrl/Cmd+V). You can paste many cells at once.</span>
    <span id="status"></span>
  </div>

  <div id="grid"></div>

  <div id="okBox" class="ok"></div>
  <div id="errorBox" class="error"></div>

  <!-- Main app logic as an ES module (supabase-js v2 via CDN ESM) -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // =========================
    // 1) CONFIG
    // =========================
    const SUPABASE_URL = "https://bfvidvslxcofuaoylhli.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_mLe7GSD1JP-1tYK1k09ZQg_mLydwaON"; // <-- KEEP YOUR REAL KEY HERE
    const TABLE_NAME = "grid_uploads";

    // Column that stores the dataset name (add this column in Supabase)
    const DATASET_COL = "dataset";

    document.getElementById("projUrl").textContent = SUPABASE_URL;
    document.getElementById("tableName").textContent = TABLE_NAME;

    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // =========================
    // 2) UI helpers
    // =========================
    const $ = (id) => document.getElementById(id);

    function setStatus(t) { $("status").textContent = t || ""; }
    function showErr(msg) {
      $("okBox").style.display = "none";
      $("errorBox").style.display = "block";
      $("errorBox").textContent = msg;
    }
    function showOk(msg) {
      $("errorBox").style.display = "none";
      $("okBox").style.display = "block";
      $("okBox").textContent = msg;
    }
    function clearMsg() {
      $("okBox").style.display = "none";
      $("errorBox").style.display = "none";
      $("okBox").textContent = "";
      $("errorBox").textContent = "";
    }

    function getDatasetName() {
      const v = ($("dataset").value || "").trim();
      return v || "default";
    }

    // A small timeout wrapper to avoid "stuck" UI
    async function withTimeout(promise, ms, label) {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(label || "timeout"), ms);
      try {
        // supabase-js doesn't accept AbortController on every method; this still protects our UI.
        return await promise;
      } finally {
        clearTimeout(t);
      }
    }

    async function requireUser() {
      const { data, error } = await sb.auth.getUser();
      if (error) throw error;
      const user = data?.user;
      if (!user) throw new Error("You must be signed in.");
      return user;
    }

    async function refreshAuthUI() {
      const { data } = await sb.auth.getUser();
      const user = data?.user;

      if (user) {
        $("whoami").textContent = user.email || user.id;
        $("signOutBtn").style.display = "";
      } else {
        $("whoami").textContent = "Not signed in";
        $("signOutBtn").style.display = "none";
      }
    }

    // =========================
    // 3) Handsontable grid
    // =========================
    const container = $("grid");
    const hot = new Handsontable(container, {
      data: Handsontable.helper.createEmptySpreadsheetData(20, 12),
      rowHeaders: true,
      colHeaders: true,
      contextMenu: true,
      manualColumnMove: true,
      manualRowMove: true,
      licenseKey: "non-commercial-and-evaluation",
      width: "100%",
      height: 460,
      stretchH: "all",
    });

    function gridTo2dArray() {
      const data = hot.getData();
      // Trim trailing completely-empty rows
      let lastNonEmptyRow = data.length - 1;
      while (lastNonEmptyRow >= 0) {
        const row = data[lastNonEmptyRow] || [];
        if (row.some((c) => String(c ?? "").trim() !== "")) break;
        lastNonEmptyRow--;
      }
      const trimmed = data.slice(0, lastNonEmptyRow + 1);
      return trimmed;
    }

    // =========================
    // 4) DB helpers
    // =========================
    async function getLatestForUserAndDataset(userId, datasetName) {
      const q = sb
        .from(TABLE_NAME)
        .select("id, user_id, created_at, rows, " + DATASET_COL)
        .eq("user_id", userId)
        .eq(DATASET_COL, datasetName)
        .order("created_at", { ascending: false })
        .limit(1);

      const { data, error } = await withTimeout(q, 15000, "Fetch latest");
      if (error) throw error;
      return data?.[0] || null;
    }

    // =========================
    // 5) Auth actions
    // =========================
    $("signUpBtn").addEventListener("click", async () => {
      clearMsg();
      setStatus("Signing up…");
      try {
        const email = $("email").value.trim();
        const password = $("password").value;
        if (!email || !password) throw new Error("Email + password required.");

        const { error } = await withTimeout(
          sb.auth.signUp({ email, password }),
          15000,
          "Sign up"
        );
        if (error) throw error;

        showOk("✅ Sign-up OK. If email confirmation is enabled, check your inbox, then sign in.");
        await refreshAuthUI();
      } catch (e) {
        showErr(e?.message || String(e));
      } finally {
        setStatus("");
      }
    });

    $("signInBtn").addEventListener("click", async () => {
      clearMsg();
      setStatus("Signing in…");
      try {
        const email = $("email").value.trim();
        const password = $("password").value;
        if (!email || !password) throw new Error("Email + password required.");

        const { data, error } = await withTimeout(
          sb.auth.signInWithPassword({ email, password }),
          15000,
          "Sign in"
        );
        if (error) throw error;

        showOk("✅ Logged in successfully");
        await refreshAuthUI();
      } catch (e) {
        showErr(e?.message || String(e));
      } finally {
        setStatus("");
      }
    });

    $("signOutBtn").addEventListener("click", async () => {
      clearMsg();
      setStatus("Signing out…");
      try {
        const { error } = await withTimeout(sb.auth.signOut(), 15000, "Sign out");
        if (error) throw error;
        showOk("✅ Signed out");
        await refreshAuthUI();
      } catch (e) {
        showErr(e?.message || String(e));
      } finally {
        setStatus("");
      }
    });

    // =========================
    // 6) Connection test
    // =========================
    $("testConnBtn").addEventListener("click", async () => {
      clearMsg();
      setStatus("Testing…");
      try {
        const { error } = await withTimeout(
          sb.from(TABLE_NAME).select("id").limit(1),
          15000,
          "Connection test"
        );
        if (error) throw error;
        showOk("✅ Connection OK (table query succeeded)");
      } catch (e) {
        showErr(
          (e?.message || String(e)) +
          "\n\nIf you see “Failed to fetch” or “Name not resolved”, double-check SUPABASE_URL and your network."
        );
      } finally {
        setStatus("");
      }
    });

    // =========================
    // 7) Save / Load / Copy JSON
    // =========================
    $("saveDb").addEventListener("click", async () => {
      clearMsg();
      setStatus("Saving…");

      try {
        const user = await requireUser();
        const payload = gridTo2dArray();
        const datasetName = getDatasetName();

        if ($("overwriteLatest").checked) {
          // Delete the latest for this dataset, then insert a fresh row (simple & reliable with RLS)
          const latest = await getLatestForUserAndDataset(user.id, datasetName);

          if (latest?.id) {
            const { error: delErr } = await withTimeout(
              sb.from(TABLE_NAME).delete().eq("id", latest.id),
              15000,
              "Delete latest"
            );
            if (delErr) throw delErr;
          }

          const { error: insErr } = await withTimeout(
            sb.from(TABLE_NAME).insert({ user_id: user.id, [DATASET_COL]: datasetName, rows: payload }),
            15000,
            "Insert new"
          );
          if (insErr) throw insErr;

          showOk(`✅ Overwrote latest for dataset "${datasetName}"`);
        } else {
          const { error } = await withTimeout(
            sb.from(TABLE_NAME).insert({ user_id: user.id, [DATASET_COL]: datasetName, rows: payload }),
            15000,
            "Insert"
          );
          if (error) throw error;
          showOk(`✅ Saved (inserted a new record) for dataset "${datasetName}"`);
        }
      } catch (e) {
        showErr(e?.message || String(e));
      } finally {
        setStatus("");
      }
    });

    $("loadDb").addEventListener("click", async () => {
      clearMsg();
      setStatus("Loading…");
      try {
        const user = await requireUser();
        const datasetName = getDatasetName();
        const latest = await getLatestForUserAndDataset(user.id, datasetName);
        if (!latest) throw new Error(`No saved data found yet for dataset "${datasetName}".`);

        hot.loadData(latest.rows || Handsontable.helper.createEmptySpreadsheetData(20, 12));
        showOk(`✅ Loaded latest for "${datasetName}" (${latest.id}) from ${new Date(latest.created_at).toLocaleString()}`);
      } catch (e) {
        showErr(e?.message || String(e));
      } finally {
        setStatus("");
      }
    });

    $("copyJson").addEventListener("click", async () => {
      clearMsg();
      setStatus("Copying…");
      try {
        const user = await requireUser();
        const datasetName = getDatasetName();
        const latest = await getLatestForUserAndDataset(user.id, datasetName);
        if (!latest) throw new Error(`No saved data found yet for dataset "${datasetName}".`);

        const text = JSON.stringify(latest.rows ?? null, null, 2);
        await navigator.clipboard.writeText(text);
        showOk(`✅ Copied latest JSON for "${datasetName}" to clipboard`);
      } catch (e) {
        showErr(e?.message || String(e));
      } finally {
        setStatus("");
      }
    });

    // =========================
    // 8) CSV / Clear
    // =========================
    $("downloadCsv").addEventListener("click", () => {
      clearMsg();
      const data = gridTo2dArray();
      const csv = data.map(row =>
        row.map(cell => {
          const s = String(cell ?? "");
          const needsQuotes = /[",\n]/.test(s);
          const escaped = s.replaceAll('"', '""');
          return needsQuotes ? `"${escaped}"` : escaped;
        }).join(",")
      ).join("\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${getDatasetName()}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      showOk("✅ CSV downloaded");
    });

    $("clearGrid").addEventListener("click", () => {
      clearMsg();
      hot.loadData(Handsontable.helper.createEmptySpreadsheetData(20, 12));
      showOk("✅ Cleared grid");
    });

    // Initial
    refreshAuthUI().catch(() => {});
  </script>

  <!--
    IMPORTANT (one-time DB change):
    Add a dataset column to your table:

    alter table public.grid_uploads
    add column if not exists dataset text not null default 'default';

    Your existing RLS policies (insert/select/delete) should still work.
    For overwrite-by-delete to work, you need the "delete own uploads" policy (you already have it).
  -->
</body>
</html>
