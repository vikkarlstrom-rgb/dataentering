<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Excel Paste Grid → CSV + Supabase Save</title>

  <!-- Handsontable Community Edition (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.5.0/dist/handsontable.full.min.css">
  <script src="https://cdn.jsdelivr.net/npm/handsontable@14.5.0/dist/handsontable.full.min.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; }
    h2 { margin-top: 0; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; margin: 10px 0; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin: 10px 0 12px; }
    button { padding: 8px 12px; cursor: pointer; }
    .warn { background:#fff7ed; border: 1px solid #fdba74; }
    .checkbox { display:inline-flex; align-items:center; gap:8px; margin-left: 6px; font-size: 14px; color:#333; }
    .checkbox input { transform: translateY(1px); }
    input { padding: 8px 10px; min-width: 220px; }
    .label { font-size: 12px; color:#555; margin-bottom: 4px; }
    .hint { color: #555; font-size: 14px; }
    #grid { width: 100%; max-width: 1200px; }
    #status { color:#444; font-size: 14px; margin-left: 6px; }
    .pill { padding: 2px 8px; border: 1px solid #ddd; border-radius: 999px; font-size: 12px; color:#333; }

    .ok { margin-top: 10px; padding: 10px 12px; border: 1px solid #b7e4c7; background: #d8f3dc; color: #1b4332; border-radius: 8px; display:none; max-width: 1200px; }
    .error { margin-top: 10px; padding: 10px 12px; border: 1px solid #f3c0c0; background: #fff4f4; color: #7a1f1f; border-radius: 8px; display:none; max-width: 1200px; }

  </style>
</head>
<body>
  <h2>Paste from Excel into the grid</h2>

  <!-- Auth -->
  <div class="row">
    <div>
      <div class="label">Email</div>
      <input id="email" type="email" placeholder="you@company.com" autocomplete="username" />
    </div>
    <div>
      <div class="label">Password</div>
      <input id="password" type="password" placeholder="password" autocomplete="current-password" />
    </div>

    <button id="signUpBtn">Sign up</button>
    <button id="signInBtn">Sign in</button>
    <button id="signOutBtn" style="display:none;">Sign out</button>

    <span class="pill" id="whoami">Not signed in</span>
  </div>

  <!-- Actions -->
  <div class="toolbar">
    <button id="downloadCsv">Download CSV</button>
    <button id="saveDb">Save to Supabase</button>
    <button id="loadDb">Load my latest</button>
    <button id="clearGrid">Clear grid</button>
    <span class="hint">Tip: click a cell, then paste (Ctrl/Cmd+V). You can paste many cells at once.</span>
    <span id="status"></span>
  </div>

  <div id="grid"></div>

  <div id="okBox" class="ok"></div>
  <div id="errorBox" class="error"></div>

  <!-- Main app logic as an ES module (needed for supabase-js v2 via CDN) -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // ========================
    // 1) CONFIG (already filled)
    // ========================
    const SUPABASE_URL = "https://bfvidvslxcofuaoylhli.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_mLe7GSD1JP-1tYK1k09ZQg_mLydwaON";
    const TABLE_NAME = "grid_uploads"; // must match your SQL table name

    const sbClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: false }
    });

    // ========================
    // 2) GRID SETUP
    // ========================
    const container = document.getElementById("grid");

    // 20 rows x 10 columns initial blank data
    const initialRows = 20;
    const initialCols = 10;
    const initialData = Array.from({ length: initialRows }, () => Array(initialCols).fill(""));

    const hot = new Handsontable(container, {
      data: initialData,
      rowHeaders: true,
      colHeaders: true,
      contextMenu: true,
      dropdownMenu: true,
      manualRowResize: true,
      manualColumnResize: true,
      manualRowMove: true,
      manualColumnMove: true,

      stretchH: "all",
      autoWrapRow: true,
      autoWrapCol: true,

      allowInsertRow: true,
      allowInsertColumn: true,
      minSpareRows: 1,
      minSpareCols: 0,

      licenseKey: "non-commercial-and-evaluation"
    });

    // ========================
    // 3) HELPERS
    // ========================
    const statusEl = document.getElementById("status");

const okBox = document.getElementById("okBox");
const errorBox = document.getElementById("errorBox");

function clearMsgs() {
  okBox.style.display = "none";
  okBox.textContent = "";
  clearMsgs();
  errorBox.textContent = "";
}

function showOk(msg) {
  clearMsgs();
  okBox.textContent = msg;
  okBox.style.display = "block";
  // auto-hide after a bit
  window.setTimeout(() => {
    if (okBox.textContent === msg) {
      okBox.style.display = "none";
    }
  }, 8000);
}

let authBusy = false;

function showError(msg, detail) {
  clearMsgs();
  errorBox.textContent = detail ? `${msg} ${detail}` : msg;
  errorBox.style.display = "block";
}

    const whoEl = document.getElementById("whoami");
    const signOutBtn = document.getElementById("signOutBtn");
    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("password");

    function setStatus(msg) { statusEl.textContent = msg || ""; }

    function isCellEmpty(v) {
      return v === null || v === undefined || String(v).trim() === "";
    }

    function trimData(data) {
      // Trim trailing empty rows
      let lastNonEmptyRow = -1;
      for (let r = 0; r < data.length; r++) {
        if (data[r].some(cell => !isCellEmpty(cell))) lastNonEmptyRow = r;
      }
      const rowsTrimmed = lastNonEmptyRow >= 0 ? data.slice(0, lastNonEmptyRow + 1) : [];

      // Trim trailing empty columns
      let lastNonEmptyCol = -1;
      for (const row of rowsTrimmed) {
        for (let c = 0; c < row.length; c++) {
          if (!isCellEmpty(row[c])) lastNonEmptyCol = Math.max(lastNonEmptyCol, c);
        }
      }
      return rowsTrimmed.map(row => row.slice(0, lastNonEmptyCol + 1));
    }

    function toCsv(data) {
      const escape = (value) => {
        const s = value === null || value === undefined ? "" : String(value);
        if (/[",\n\r]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
        return s;
      };
      return data.map(row => row.map(escape).join(",")).join("\r\n");
    }

    function download(filename, text) {
      const blob = new Blob([text], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ========================
    // 4) AUTH UI
    // ========================
    async function refreshUserUI() {
      const { data: { session } } = await sbClient.auth.getSession();
      const user = session?.user;
      whoEl.textContent = user ? `Signed in as ${user.email}` : "Not signed in";
      signOutBtn.style.display = user ? "inline-block" : "none";
    }

    document.getElementById("signUpBtn").addEventListener("click", async () => {
      setStatus("");
      const email = emailEl.value.trim();
      const password = passEl.value;
      if (!email || !password) return alert("Enter email + password");
      const { error } = await sbClient.auth.signUp({ email, password });
      if (error) return alert(error.message);
      alert("Signed up! If 'Confirm email' is enabled, check your inbox to confirm before signing in.");
      refreshUserUI();
    });

    document.getElementById("signInBtn").addEventListener("click", async () => {
      setStatus("");
      const email = emailEl.value.trim();
      const password = passEl.value;
      if (!email || !password) return alert("Enter email + password");
      const { error } = await sbClient.auth.signInWithPassword({ email, password });
      if (error) return alert(error.message);
      refreshUserUI();
    });

    signOutBtn.addEventListener("click", async () => {
      setStatus("");
      const { error } = await sbClient.auth.signOut();
      if (error) alert(error.message);
      refreshUserUI();
    });

    sbClient.auth.onAuthStateChange(() => refreshUserUI());
    refreshUserUI();

    // ========================
    // 5) BUTTONS
    // ========================
    document.getElementById("downloadCsv").addEventListener("click", () => {
      setStatus("");
      const cleaned = trimData(hot.getData());
      const csv = toCsv(cleaned);
      download("data.csv", csv);
    });

    document.getElementById("clearGrid").addEventListener("click", () => {
      setStatus("");
      hot.loadData(Array.from({ length: initialRows }, () => Array(initialCols).fill("")));
    });

    document.getElementById("saveDb").addEventListener("click", async () => {
      clearMsgs();
      const { data: { session } } = await sbClient.auth.getSession();
      if (!session?.user) return alert("Please sign in first.");

      const cleaned = trimData(hot.getData());
      if (!cleaned.length) return alert("Nothing to save (grid is empty).");

      const overwrite = document.getElementById("overwriteLatest")?.checked ?? false;

      setStatus("Saving…");
      try {
        if (overwrite) {
          const { data: latest, error: selErr } = await sbClient
            .from(TABLE_NAME)
            .select("id, created_at")
            .eq("user_id", session.user.id)
            .order("created_at", { ascending: false })
            .limit(1);

          if (selErr) throw selErr;

          if (latest && latest.length) {
            const latestId = latest[0].id;
            const { error: updErr } = await sbClient
              .from(TABLE_NAME)
              .update({ rows: cleaned })
              .eq("id", latestId);

            if (updErr) throw updErr;
            setStatus("Updated latest!");
            setTimeout(() => setStatus(""), 2500);
            return;
          }
        }

        const { error } = await sbClient.from(TABLE_NAME).insert({
          user_id: session.user.id,
          rows: cleaned
        });
        if (error) throw error;

        setStatus("Saved!");
        setTimeout(() => setStatus(""), 2500);
      } catch (e) {
        showError("Save failed.", e?.message || String(e));
        setStatus("");
      }
    });

document.getElementById("loadDb").addEventListener("click", async () => {
      setStatus("");
      const { data: { session } } = await sbClient.auth.getSession();
      if (!session?.user) return alert("Please sign in first.");

      setStatus("Loading…");
      const { data, error } = await sbClient
        .from(TABLE_NAME)
        .select("rows, created_at")
        .order("created_at", { ascending: false })
        .limit(1);

      if (error) {
        setStatus("");
        return alert(error.message);
      }
      if (!data?.length) {
        setStatus("");
        return alert("No saved uploads found.");
      }

      hot.loadData(data[0].rows);
      setStatus("Loaded latest!");
      setTimeout(() => setStatus(""), 2500);
    });
  
    document.getElementById("copyJson").addEventListener("click", async () => {
      clearMsgs();
      const { data: { session } } = await sbClient.auth.getSession();
      if (!session?.user) return alert("Please sign in first.");

      setStatus("Copying…");
      try {
        const { data, error } = await sbClient
          .from(TABLE_NAME)
          .select("id, created_at, rows")
          .eq("user_id", session.user.id)
          .order("created_at", { ascending: false })
          .limit(1)
          .single();

        if (error) throw error;
        await navigator.clipboard.writeText(JSON.stringify(data, null, 2));

        setStatus("Copied latest JSON!");
        setTimeout(() => setStatus(""), 2500);
      } catch (e) {
        showError("Copy failed.", e?.message || String(e));
        setStatus("");
      }
    });


    async function testSupabaseConnection() {
      // 1) DNS/health check
      const r = await fetch(`${SUPABASE_URL}/auth/v1/health`);
      if (!r.ok) throw new Error(`Health check failed (${r.status})`);
      // 2) basic table call (may still fail with RLS, but connectivity will be proven)
      const { error } = await sbClient.from(TABLE_NAME).select("id").limit(1);
      if (error) throw error;
    }

    document.getElementById("testConnBtn").addEventListener("click", async () => {
      clearMsgs();
      setStatus("Testing…");
      try {
        await testSupabaseConnection();
        setStatus("Supabase connection OK.");
        setTimeout(() => setStatus(""), 2500);
      } catch (e) {
        showError("Connection test failed.", (e?.message || String(e)) + "\n\nIf this says ‘Failed to fetch’, update Supabase → Authentication → URL Configuration with your GitHub Pages URL.");
        setStatus("");
      }
    });

</script>
</body>
</html>
